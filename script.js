document.addEventListener('DOMContentLoaded', () => {
    const messageTextContentElement = document.getElementById('message-text-content');
    const choicesAreaElement = document.getElementById('choices-area');
    const feedbackTextElement = document.getElementById('feedback-text');
    const nextQuestionBtn = document.getElementById('next-question-btn');
    const quizAreaElement = document.getElementById('quiz-area');
    const resultAreaElement = document.getElementById('result-area');
    const restartBtn = document.getElementById('restart-btn');
    const progressBarElement = document.getElementById('progress-bar');
    const progressTextElement = document.getElementById('progress-text');
    const currentScoreValueElement = document.getElementById('current-score-value');
    const currentScoreDisplayElement = document.querySelector('.current-score-display');

    const resultIconContainer = document.getElementById('result-icon-container');
    const resultRankTitleElement = document.getElementById('result-rank-title');
    const finalScoreValueElement = document.getElementById('final-score-value');
    const totalQuestionsOnResultElement = document.getElementById('total-questions-on-result');
    const resultMessageElement = document.getElementById('result-message');
    
    const appContainer = document.querySelector('.app-container'); // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Çø„Éº„Ç≤„ÉÉ„Éà

    let allQuizData = []; 
    let currentQuizSet = []; 
    let currentQuestionIndex = 0;
    let score = 0;
    const TARGET_NUM_QUESTIONS = 10; 

    async function initializeQuiz() {
        if(appContainer) { 
            // CSS handles entrance animation
        }
        try {
            //const response = await fetch('quiz_data.json');
            const response = await fetch('quiz_data2.json');
            if (!response.ok) throw new Error(`HTTP error! Quiz data not found. Status: ${response.status}`);
            allQuizData = await response.json(); 
            if (!Array.isArray(allQuizData) || allQuizData.length === 0) {
                displayError("„ÇØ„Ç§„Ç∫„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ„Åã„ÄÅÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
                return;
            }
            prepareNewQuizSet(); 
            startGame();
        } catch (error) {
            console.error("„ÇØ„Ç§„Ç∫„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Åæ„Åü„ÅØÂàùÊúüÂåñ„Å´Â§±Êïó:", error);
            displayError(`„ÇØ„Ç§„Ç∫„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${error.message}. JSON„Éï„Ç°„Ç§„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
        }
    }

    function prepareNewQuizSet() {
        let shuffledData = shuffleArray([...allQuizData]); 
        currentQuizSet = shuffledData.slice(0, TARGET_NUM_QUESTIONS); 
        if (currentQuizSet.length === 0 && allQuizData.length > 0) {
             currentQuizSet = shuffledData.slice(0, allQuizData.length); 
        }
    }
    
    function displayError(message) { 
        quizAreaElement.innerHTML = `<p class="error-message">${message}</p>`;
        quizAreaElement.style.display = 'block';
        resultAreaElement.style.display = 'none';
        const header = document.querySelector('.quiz-header');
        if(header) header.style.display = 'none';
    }

    function startGame() {
        currentQuestionIndex = 0;
        score = 0;
        if(currentScoreValueElement) currentScoreValueElement.textContent = '0';
        if(currentScoreDisplayElement) currentScoreDisplayElement.classList.remove('score-updated');
        
        resultAreaElement.style.display = 'none';
        const resultCard = document.querySelector('.result-card');
        if(resultCard) { 
            resultCard.style.animation = 'none'; 
            resultCard.offsetHeight; 
            resultCard.style.animation = ''; 
        }
        
        quizAreaElement.style.display = 'block';
        nextQuestionBtn.style.display = 'none';
        feedbackTextElement.textContent = '';
        feedbackTextElement.className = 'feedback-text'; 
        
        if (currentQuizSet.length === 0) {
            displayError("Âá∫È°å„Åß„Åç„Çã„ÇØ„Ç§„Ç∫„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Éà„Éº„ÇØÂ±•Ê≠¥„ÇÑPython„Çπ„ÇØ„É™„Éó„Éà„ÅÆ„Éï„Ç£„É´„Çø„ÉºÊù°‰ª∂„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            return;
        }
        updateProgress();
        displayQuestion();
    }

    function displayQuestion() {
        if (currentQuestionIndex < currentQuizSet.length) {
            const currentQuestion = currentQuizSet[currentQuestionIndex];
            messageTextContentElement.innerHTML = currentQuestion.message.replace(/\n/g, '<br>');
            choicesAreaElement.innerHTML = ''; 
            currentQuestion.choices.forEach(choice => {
                const button = document.createElement('button');
                button.textContent = choice;
                button.addEventListener('click', () => handleAnswer(choice, currentQuestion.answer));
                choicesAreaElement.appendChild(button);
            });
            feedbackTextElement.textContent = '';
            feedbackTextElement.className = 'feedback-text';
            nextQuestionBtn.style.display = 'none';
        } else {
            showResults();
        }
    }

    function handleAnswer(selectedChoice, correctAnswer) {
        const buttons = choicesAreaElement.getElementsByTagName('button');
        let selectedButtonElement = null;
        for (let btn of buttons) {
            btn.disabled = true;
            if (btn.textContent === selectedChoice) selectedButtonElement = btn;
            if (btn.textContent === correctAnswer) btn.classList.add('reveal-correct');
        }
        
        feedbackTextElement.classList.add('visible');

        if (selectedChoice === correctAnswer) {
            score++;
            if(currentScoreValueElement) currentScoreValueElement.textContent = score;
            if(currentScoreDisplayElement) {
                currentScoreDisplayElement.classList.add('score-updated');
                setTimeout(() => currentScoreDisplayElement.classList.remove('score-updated'), 300);
            }
            feedbackTextElement.textContent = "Ê≠£Ëß£ÔºÅüéâ";
            feedbackTextElement.classList.add('correct');
            if (selectedButtonElement) {
                selectedButtonElement.classList.remove('reveal-correct');
                selectedButtonElement.classList.add('correct');
            }
            if (typeof confetti === 'function') {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.65 }, zIndex: 10000, scalar: 1.1 });
            }
        } else {
            feedbackTextElement.textContent = `ÊÆãÂøµÔºÅÊ≠£Ëß£„ÅØ„Äå${correctAnswer}„Äç„Åß„Åó„Åü„ÄÇ`;
            feedbackTextElement.classList.add('wrong');
            if (selectedButtonElement) selectedButtonElement.classList.add('wrong');
            
            // --- ‰∏çÊ≠£Ëß£ÊôÇ„ÅÆÊºîÂá∫ („Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Ç∑„Çß„Ç§„ÇØ) ---
            feedbackTextElement.classList.add('feedback-text-shake');
            setTimeout(() => {
                feedbackTextElement.classList.remove('feedback-text-shake');
            }, 400); // CSS„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÊôÇÈñì„Å®Âêà„Çè„Åõ„Çã
            // --- „Åì„Åì„Åæ„Åß ---
        }
        nextQuestionBtn.style.display = 'inline-flex';
    }

    function updateProgress() {
        const totalQuestionsInSet = currentQuizSet.length;
        if (totalQuestionsInSet > 0) {
            const progressPercentage = ((currentQuestionIndex) / totalQuestionsInSet) * 100;
            progressBarElement.style.width = `${progressPercentage}%`;
            progressTextElement.textContent = `ÂïèÈ°å ${currentQuestionIndex + 1} / ${totalQuestionsInSet}`;
        } else {
            progressBarElement.style.width = `0%`;
            progressTextElement.textContent = `ÂïèÈ°å - / -`;
        }
    }

    function showResults() {
        quizAreaElement.style.display = 'none';
        resultAreaElement.style.display = 'block'; 
        const resultCard = document.querySelector('.result-card');
        if(resultCard) { resultCard.style.animation = 'none'; resultCard.offsetHeight; resultCard.style.animation = ''; }
        
        const totalAnswered = currentQuizSet.length;
        totalQuestionsOnResultElement.textContent = totalAnswered;
        let rank = '', rankTitle = '', message = '', iconClass = ''; 
        const percentage = totalAnswered > 0 ? Math.round((score / totalAnswered) * 100) : 0;

        if (score === totalAnswered && totalAnswered > 0) { 
            rank = 'splus'; 
            rankTitle = "‰∏≠ÊØí„ÅäÁñ≤„Çåü§°";
            message = "ÂÖ®ÂïèÊ≠£Ëß£‚Ä¶„Åï„Å¶„ÅØ„ÄÅ„Éà„Éº„ÇØÂ±•Ê≠¥„Å®ÂÖ±„Å´Áîü„Åç„Å¶„Åæ„Åô„ÅãÔºü„É™„Ç¢„É´„ÅÆ‰∫∫ÈñìÈñ¢‰øÇ„ÇíÊßãÁØâ„Åó„Åü„Çâ„Å©„ÅÜ„Åß„Åô„ÅãÔºü";
            iconClass = 'fas fa-crown'; 
            if (typeof confetti === 'function') { 
                setTimeout(() => { 
                     confetti({ particleCount: 250, spread: 180, origin: { y: 0.25 }, angle: 270, drift: 0.1, gravity: 0.7, zIndex: 10000, scalar: 1.3, ticks: 300, colors: ['#FFD700', '#FF69B4', '#8A2BE2', '#000000'] });
                     confetti({ particleCount: 200, spread: 160, origin: { y: 0.35 }, zIndex: 10000, ticks: 300, colors: ['#FFFFFF', '#4B0082', '#FF0000'] });
                }, 700);
            }
        } else if (percentage >= 90) {
            rank = 's'; 
            rankTitle = "Áúü„ÅÆ„Éà„Éº„ÇØ„Éû„Çπ„Çø„Éº";
            message = "„Åª„ÅºÂÆåÁíßÔºÅ„ÅÇ„Å™„Åü„ÅÆÂâç„Åß„ÅØ„ÄÅ„Å©„Çì„Å™‰∫õÁ¥∞„Å™Áô∫Ë®Ä„ÇÇË¶ãÈÄÉ„Åï„Çå„Åæ„Åõ„Çì„Å≠„ÄÇ„Åæ„Åï„Å´Á•ûÊ•≠ÔºÅ";
            iconClass = 'fas fa-award'; // Replaced fa-dragon
        } else if (percentage >= 80) {
            rank = 'aplus'; 
            rankTitle = "„Éà„Éº„ÇØ„Éû„Çπ„Çø„Éº"; // User's title, refined from "Ë∂ÖÁµ∂ÊäÄÂ∑ß„É™„Çπ„Éä„Éº"
            message = "„ÅäË¶ã‰∫ãÔºÅ„Åù„ÅÆÊ¥ûÂØüÂäõ„ÄÅ„Åæ„Åï„Å´ÈÅî‰∫∫„ÅÆÂüü„Åß„ÅôÔºÅ";
            iconClass = 'fas fa-medal'; // Replaced fa-gem
        } else if (percentage >= 70) {
            rank = 'a';
            rankTitle = "Áô∫Ë®Ä„ÇΩ„É†„É™„Ç®";
            message = "„ÅäË¶ã‰∫ãÔºÅÁöÑÁ¢∫„Å™ÂàÜÊûêÂäõ„ÄÅÊµÅÁü≥„Åß„Åô„ÄÇ„Éà„Éº„ÇØ„ÅÆÊ©üÂæÆ„ÇíÂøÉÂæó„Å¶„ÅÑ„Åæ„Åô„Å≠ÔºÅ";
            iconClass = 'fas fa-star'; // Kept fa-star, or use fa-certificate
        } else if (percentage >= 60) {
            rank = 'bplus';
            rankTitle = "‰∫ãÊÉÖÈÄö„Ç®„Éº„Ç∏„Çß„É≥„Éà";
            message = "„Åã„Å™„ÇäË©≥„Åó„ÅÑ„Åß„Åô„Å≠ÔºÅÈáçË¶ÅÊÉÖÂ†±„ÇíË¶ãÊäú„Åè„Çπ„Éë„Ç§„ÅÆÁ¥†Ë≥™„Ç¢„É™‚Ä¶„Åã„ÇÇÔºü";
            iconClass = 'fas fa-user-secret'; // This is a Free icon
        } else if (percentage >= 40) {
            rank = 'b';
            rankTitle = "Ë¶ãÁøí„ÅÑÊé®Ë´ñËÄÖ";
            message = "Âü∫Êú¨„ÅÆË¶≥ÂØü„ÅØOKÔºÅÊñáËÑà„ÇÑË™ûÂ∞æ„ÅÆ„ÇØ„Çª„Çí„ÇÇ„Å£„Å®Ë™≠„ÅøËß£„ÅÑ„Å¶„ÄÅË™∞„ÅÆÁô∫Ë®Ä„ÅãÈã≠„ÅèË¶ãÊäú„ÅÑ„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ(ÁúüÈù¢ÁõÆ„Å™„Ç¢„Éâ„Éê„Ç§„Çπ)";
            iconClass = 'fas fa-search'; // Replaced fa-ear-listen
        } else if (percentage >= 30) {
            rank = 'b';
            rankTitle = "„ÅÜ„Çè„ÅïÂ•Ω„Åç„ÅÆÈö£‰∫∫";
            message = "„Åä„Å£„Å®„ÄÅËÅû„ÅçËÄ≥„ÇíÁ´ã„Å¶„Å¶„Åæ„Åó„ÅüÔºü„Ç¥„Ç∑„ÉÉ„Éó„ÅÆÈ¶ô„Çä„Åå„Åó„Åæ„Åô„Çà‚Ä¶„ÇÇ„ÅÜÂ∞ë„Åó„ÅßÊ†∏ÂøÉ„Å´Ëø´„Çå„Åü„ÅÆ„Å´ÔºÅÊÆãÂøµ...";
            iconClass = 'fas fa-magnifying-glass'; // Replaced fa-ear-listen
        } else if (percentage >= 20) {
            rank = 'c';
            rankTitle = "„Å≤„Çâ„ÇÅ„Åç„ÅÆÂçµ";
            message = "„ÅÇ„Å®‰∏ÄÊ≠©„Åß„Åª„Çì„ÅÆÂ∞ë„Åó„Å†„ÅëË¨é„ÅåËß£„Åë„Åù„ÅÜ‚Ä¶„ÇÇ„ÅÜÂ∞ë„ÅóÊ∑±Êéò„Çä„Åó„Å¶„Åø„Å¶„ÅØÔºü";
            iconClass = 'fas fa-compass';
        } else if (percentage >= 10) {
            rank = 'd';
            rankTitle = "Ëµ§„Å°„ÇÉ„Çì";
            message = "„Åæ„Å†„Åæ„Å†Ëµ§„Å°„ÇÉ„Çì„ÅÆÊÆµÈöé„Åß„Åô„Åå„ÄÅ„Åù„ÅÆÁã¨ÂâµÊÄß„ÅåÂÖâ„Å£„Å¶„Åæ„ÅôÔºÅÊ¨°„ÅØ„Åï„Çâ„Å´Á™ÅÊãçÂ≠ê„ÇÇ„Å™„ÅÑÊé®Ë´ñ„ÇíÊúüÂæÖ„Åó„Å¶„Åæ„Åô„Çà„ÄÇ";
            iconClass = 'fas fa-lightbulb';
        } else {
            rank = 'e';
            rankTitle = "ËÉΩÁÑ°„Åó";
            message = "„ÇÑ„ÇãÊ∞ó„Å™„ÅÑ„Å™„ÇâÂ∏∞„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„ÅÇ„Å™„Åü„ÅØ‰Ωï„Çí„ÇÑ„Å£„Å¶„ÇÇ„ÅÜ„Åæ„Åè„ÅÑ„Åã„Å™„ÅÑ„Åß„Åó„Çá„ÅÜ„ÄÇ";
            iconClass = 'fas fa-egg';
        }
        
        resultIconContainer.className = `result-icon-container rank-${rank}`; 
        resultIconContainer.innerHTML = `<i class="${iconClass}"></i>`;
        resultRankTitleElement.textContent = rankTitle;
        resultRankTitleElement.className = `result-rank-title rank-${rank}`; 
        resultMessageElement.textContent = message;
        animateValue(finalScoreValueElement, 0, score, 700 + score * 50);
        progressBarElement.style.width = '100%';
        progressTextElement.textContent = `ÂÖ® ${totalAnswered} ÂïèÂÆå‰∫ÜÔºÅ`;
    }
    
    function animateValue(element, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            element.textContent = Math.floor(progress * (end - start) + start);
            if (progress < 1) { window.requestAnimationFrame(step); }
        };
        window.requestAnimationFrame(step);
    }

    function shuffleArray(array) { 
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }
    function randomRange(min, max) { return Math.random() * (max - min) + min; }
    
    document.getElementById('current-year').textContent = new Date().getFullYear();
    nextQuestionBtn.addEventListener('click', () => {
        currentQuestionIndex++;
        if (currentQuestionIndex < currentQuizSet.length) {
            displayQuestion();
            updateProgress(); 
        } else {
            progressBarElement.style.width = '100%'; 
            progressTextElement.textContent = `ÁµêÊûú„ÇíË®àÁÆó‰∏≠...`; 
            showResults();
        }
    });
    restartBtn.addEventListener('click', () => {
        prepareNewQuizSet(); 
        startGame();
    });
    initializeQuiz();
});
